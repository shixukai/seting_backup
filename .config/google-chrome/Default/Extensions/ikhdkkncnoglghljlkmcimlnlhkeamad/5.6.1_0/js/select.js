!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["./lib/jquery","./lib/doT"],b):a.Select=b(jQuery,doT)}(this,function(a,b){"use strict";function c(b){return f?f:(f=this,this.config=a.extend({alwaysShow:!1,enable:!0,autoPlay:!1,ignoreChinese:!1,ignoreNumLike:!0,showTranslateButton:!0,waitText:"正在翻译，请稍候……",needCtrl:!1,template:"划词翻译刚才自动更新了，请重启浏览器后重试。"},b),this.position={left:0,top:0},this.loading=!1,this.curQuery=null,this.curResult=null,this.dom_result=d(),this.dom_btn=e(),void 0)}function d(){var a=document,b=a.createElement("lmk-container"),c={},d=function(a){var d=a.pageX-c.x,e=a.pageY-c.y;a.preventDefault(),0>d&&(d=0),0>e&&(e=0),b.style.left=d+"px",b.style.top=e+"px"},e=function(){this.removeEventListener("mousemove",d,!0),this.removeEventListener("mouseup",e,!0)},f=function(f){f.stopPropagation(),0===f.button&&"LMK-MOVE"===f.target.nodeName&&(c.x=f.pageX-b.offsetLeft,c.y=f.pageY-b.offsetTop,a.addEventListener("mousemove",d,!0),a.addEventListener("mouseup",e,!0))};return b.dataset.hello="我是由“划词翻译”生成的，不要担心;)",b.addEventListener("mousedown",f,!0),b}function e(){var a=document.createElement("lmk-translate");return a.dataset.hello="我是由“划词翻译”生成的，不要担心;)",a.textContent="译",a}var f;return c.send=function(b){var c=a.Deferred();try{chrome.runtime.sendMessage(b,function(a){var b=chrome.runtime.lastError;b||!a?(c.reject("获取查询结果时发生了错误，请尝试刷新网页或重启浏览器后重试。",b),console.error(b)):c.resolve(a)})}catch(d){c.reject("连接到翻译引擎时发生了错误，请尝试刷新网页或重启浏览器后重试。",d)}return c.promise()},a.extend(c.prototype,{getText:function(){return getSelection().toString().trim()},render:function(){return this.render=b.template(this.config.template),this.render.apply(null,arguments)},offset:function(a){return this.position={left:a.pageX+10-window.pageXOffset,top:a.pageY+10-window.pageYOffset},this},show:function(){return document.body.appendChild(this.dom_result),this.show=function(b,c){var d=this.position,e=this.dom_result;return b.config=a.extend({},this.config),e.innerHTML=this.render(b),e.classList.add("lmk-show"),this.config.alwaysShow||c||(e.style.top=d.top+10+"px",e.style.left=d.left+"px",d.top+10+e.clientHeight>window.innerHeight&&d.top-10-e.clientHeight>0&&(e.style.top=d.top-10-e.clientHeight+"px"),d.left+e.clientWidth>window.innerWidth&&d.left-e.clientWidth>0&&(e.style.left=d.left-e.clientWidth+"px")),this},this.show.apply(this,arguments)},showBtn:function(){return document.body.appendChild(this.dom_btn),this.showBtn=function(){if(!this.loading){var a=this.position,b=this.dom_btn;b.style.top=a.top+"px",b.style.left=a.left+"px",b.classList.add("lmk-show")}return this},this.showBtn.apply(this,arguments)},hide:function(){return this.loading||this.config.alwaysShow||this.dom_result.classList.remove("lmk-show"),this},hideBtn:function(){return this.dom_btn.classList.remove("lmk-show"),this},isInDom:function(b){return a.contains(this.dom_result,b)},check:function(a,b){var c=this.config;if(b||(b=this.getText()),b&&c.enable&&!this.isInDom(a.target)){if(c.ignoreChinese&&/[\u4e00-\u9fa5]/.test(b))return!1;if(c.ignoreNumLike&&/^[\s.\-0-9()•+]+$/.test(b))return!1;if(!c.showTranslateButton&&c.needCtrl&&!a.ctrlKey)return!1;if(0===a.button)return!0}return!1},translate:function(a,b){var c,d=typeof a;return"string"===d?a={text:a}:a||(a={text:this.getText()}),a.text&&!this.loading&&(this.loading=!0,this.curQuery=a,c=this,this.show({wait:this.config.waitText},b).getResult(a).always(function(){setTimeout(function(){c.loading=!1},100)}).done(function(a){if(c.curResult=a,a.error&&(a.error=a.error.replace("重试","<lmk-retry>重试</lmk-retry>")),c.show(a,b),c.config.autoPlay){var d=document.querySelector("lmk-icon-play");d&&d.click()}}).fail(function(a){c.show({error:a.replace("重试","<lmk-retry>重试</lmk-retry>")},b)})),this},getResult:function(a){return c.send({from:"content",to:"background",action:"translate",data:a})},copy:function(a){return c.send({from:"content",to:"background",action:"copy",data:a}),this},play:function(a){return c.send({from:"content",to:"background",action:"play",data:{text:this.curQuery[a]||this.curResult[a],from:"text"===a?this.curResult.from:this.curResult.to,apiId:this.curResult.api.id}}),this},web:function(){if(!a("#OUTFOX_JTR_CDA").length){var b,c,d,e,f,g,h,i="https://fanyi.youdao.com/web2",j=document,k=j.body;window.OUTFOX_JavascriptTranslatoR?(c="https://fanyi.youdao.com",d="/web2/conn.html",e=i+"/index.do",f=c+"/jtr",g=i+"/rl.do",h=i+"/styles/all-packed.css",J.loadCSS(j,h),window.OUTFOX_JavascriptTranslatoR=new J.TR.UI(k,{domain:c,update:!1,updateTipMsg:"增加关闭按钮",updateDate:"2011-3-15",cssURL:h,tipsURL:e,transURL:f,logURL:g,connFilePath:d,reqSize:20})):(b=j.createElement("script"),b.src=chrome.extension.getURL("")+"js/lib/ydwa.js",b.async=!0,j.head.appendChild(b))}return this}}),c}),function(a,b,c){"use strict";var d=new b;c.get(d.config).done(function(e){a.extend(d.config,e),document.addEventListener("mousedown",function(a){d.dom_btn===a.target?(a.preventDefault(),d.translate()):d.isInDom(a.target)||d.hide(),d.hideBtn()},!0),a(document).on("mouseup",function(a){d.offset(a),setTimeout(function(){d.check(a)&&(!d.config.showTranslateButton||d.config.needCtrl&&a.ctrlKey?d.translate():d.showBtn())},0)}).on("click","[data-lmk123-action]",function(){switch(this.dataset.lmk123Action){case"translate":d.translate({text:d.curQuery.text,apiId:this.dataset.apiId},!0);break;case"web":d.web()}}).on("click","lmk-icon-pin",function(){this.classList.toggle("lmk-pined"),d.config.alwaysShow=this.classList.contains("lmk-pined")}).on("click","lmk-icon-setting",function(){b.send({action:"createTab",data:{url:"/options.html"}})}).on("click","lmk-footer lmk-a",function(){b.send({action:"createTab",data:{url:d.curResult.linkToResult}})}).on("click","lmk-retry",function(){d.translate({text:d.curQuery.text,apiId:d.curResult.api.id},!0)}).on("click","lmk-icon-play",function(){d.play(this.dataset.lmk123Play)}).on("click","lmk-icon-copy",function(){d.copy(this.parentNode.textContent.trim()),this.classList.add("lmk-copy")}).on("click","lmk-switch",function(){this.classList.toggle("lmk-close"),chrome.storage.local.set({enable:!this.classList.contains("lmk-close")})}),chrome.runtime.onMessage.addListener(function(a){switch(a.action){case"translate":d.translate();break;case"web":d.web()}}),c.onChange(function(b){a.extend(d.config,b)},d.config)})}(jQuery,Select,storage);