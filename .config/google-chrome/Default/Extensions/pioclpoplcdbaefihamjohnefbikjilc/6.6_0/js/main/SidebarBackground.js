/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
define(["GlobalUtils","isTest"],function(a,b){"use strict";function c(a,b){function c(){var c={},d=extension.getPendingNote(a.pendingNoteKey);d||(d={}),d.relatedNotes||(d.relatedNotes={}),d.relatedNotes.pers=i&&i.relatedNotes?i.relatedNotes.list:[],j&&(d.relatedNotes.biz=j.relatedNotes?j.relatedNotes.list:[],d.relatedNotes.containingNotebooks=h),extension.setPendingNote(a.pendingNoteKey,d),a.notesOnly?a.callback(a.pendingNoteKey,b):("smartFiling"===options.get("notebookSelection")&&(i&&i.notebook&&(c.notebook=i.notebook),p&&options.get("bizSmartFilingEnabled")&&j&&j.notebook&&!j.notebook.restrictions.noCreateNotes&&(c.notebook=j.notebook,c.notebook.biz=!0)),options.get("smartFilingTags")&&(i&&i.tags&&(c.tags=i.tags),p&&j&&j.tags&&c.notebook&&c.notebook.biz&&(c.tags=j.tags)),c.name="receiveSmartFilingInfo",Browser.sendToTab(b.tab,c))}function d(){k=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),extension.getBootstrapInfo("serviceHost"),options.get("overrideServiceURL")),k.initWithAuthToken(o,function(){p?(l=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),extension.getBootstrapInfo("serviceHost"),options.get("overrideServiceURL")),l.initWithAuthToken(p,function(){e()})):e()})}function e(){var c={relatedNotesResultSpec:{includeAttributes:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0},text:a.recText,url:a.url||b.tab.url};options.get("includeDebugInfo")&&(c.relatedNotesResultSpec.includeDebugInfo=!0);var d=options.get("relatedNotesContext").trim();""!=d&&(c.context=d),JsonQueue.handleExpensiveOpRequest({shardId:k.shardId,userId:q,type:"pers"},k.client.NoteStoreExtra.getFilingRecommendations,g,o,c),p&&JsonQueue.handleExpensiveOpRequest({shardId:l.shardId,userId:q,type:"biz"},l.client.NoteStoreExtra.getFilingRecommendations,f,p,c)}function f(a,b){if(n=!0,a){if(a.relatedNotes){h={};for(var d=0;d<a.containingNotebooks.list.length;d++){var e=a.containingNotebooks.list[d];h[e.guid]={joined:e.hasSharedNotebook,name:e.notebookDisplayName,contact:e.contactName}}}a.debugInfo&&(r.write("DEBUG_INFO",a.debugInfo),delete a.debugInfo),j=a}else log.error(b);m&&c()}function g(b,d){m=!0,b?(i=b,b.debugInfo&&(r.write("TEXT",a.recText),r.write("DEBUG_INFO",b.debugInfo),delete b.debugInfo)):log.error(d),(p&&n||!p)&&c()}var h,i,j,k,l,m,n,o=auth.getUserInfo().authenticationToken,p=auth.getUserInfo().bizAuthenticationToken,q=auth.getCurrentUser(),r=new LogWriter("relatedNotesDebugInfo");a.recText&&a.recText.trim()?d():c()}function d(b,c){function d(){e(),f(),w.bizAuthenticationToken?g():Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",notebooks:[]})}function e(){N.getFilteredSyncChunk(w.authenticationToken,J[x].personal,v,new SyncChunkFilter({includeExpunged:K,includeNotebooks:!0,omitSharedNotebooks:!0}),h,n)}function f(){N.getFilteredSyncChunk(w.authenticationToken,J[x].linked,v,new SyncChunkFilter({includeExpunged:L,includeLinkedNotebooks:!0}),i,n)}function g(){P.getFilteredSyncChunk(w.bizAuthenticationToken,J[x].business,v,new SyncChunkFilter({includeExpunged:M,includeNotebooks:!0,omitSharedNotebooks:!0}),j,n)}function h(a){for(var d in a.notebooks)r(F[x].personal,F[x].personalIndices,a.notebooks[d]);for(var d in a.expungedNotebooks)s(F[x].personal,F[x].personalIndices,a.expungedNotebooks[d]);Persistent.set("notebooks",F),J[x].personal=a.chunkHighUSN,Persistent.set("updateCounts",J),a.updateCount===J[x].personal?Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receivePersonalNotebooks",alwaysStartInNotebookGuid:I,notebooks:F[x].personal,recentNotebookGuid:H}):e()}function i(a){for(var b in a.linkedNotebooks){var c=a.linkedNotebooks[b];c.sharedNotebookGlobalId&&c.shardId&&(r(F[x].linked,F[x].linkedIndices,c),O[c.shardId]||(O[c.shardId]=extension.createNoteStoreClient(c.shardId)),y&&c.businessId===y?z++:B++,O[c.shardId].authenticateToSharedNotebook(c.sharedNotebookGlobalId,w.authenticationToken,k(c.shardId,c),o(c,"authenticateToSharedNotebook")))}for(var b in a.expungedLinkedNotebooks)t(a.expungedLinkedNotebooks[b]);Persistent.set("notebooks",F),J[x].linked=a.chunkHighUSN,Persistent.set("updateCounts",J),a.updateCount===J[x].linked?(D=!0,p(),q()):f()}function j(a){for(var b in a.notebooks){var c=a.notebooks[b];r(F[x].business,F[x].businessIndices,c),s(F[x].shared,F[x].sharedIndices,c.guid,F[x].sharedOwners)}for(var b in a.expungedNotebooks)s(F[x].business,F[x].businessIndices,a.expungedNotebooks[b]);Persistent.set("notebooks",F),J[x].business=a.chunkHighUSN,Persistent.set("updateCounts",J),a.updateCount===J[x].business?(E=!0,p()):g()}function k(a,b){return function(c){c.authenticationToken?O[a].getSharedNotebookByAuth(c.authenticationToken,l(a,c,b,c.user||c.publicUserInfo),o(b,"getSharedNotebookByAuth")):y&&b.businessId===y?(A++,p()):(C++,q())}}function l(a,b,c,d){return function(e){F[x].linkedGuidToGuid[c.guid]&&F[x].linkedGuidToGuid[c.guid]!==e.notebookGuid&&(s(F[x].business,F[x].businessIndices,F[x].linkedGuidToGuid[c.guid]),s(F[x].shared,F[x].sharedIndices,F[x].linkedGuidToGuid[c.guid],F[x].sharedOwners)),F[x].linkedGuidToGuid[c.guid]=e.notebookGuid,Persistent.set("notebooks",F),y&&c.businessId===y?(A++,p()):O[a].getNotebook(b.authenticationToken,e.notebookGuid,m(d),o(c,"getNotebook"))}}function m(a){return function(b){r(F[x].shared,F[x].sharedIndices,b,F[x].sharedOwners,a),Persistent.set("notebooks",F),C++,q()}}function n(a){extension.isThriftError(a)&&a.errorCode===EDAMErrorCode.PERMISSION_DENIED&&"Business"===a.parameter?auth.updateUserStatus(function(){w=auth.getUserInfo(),w.bizAuthenticationToken?log.error("got error that user was not in business, but still got business token here"):Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",notebooks:[]})}):log.error(a)}function o(a,b){return function(c){var d="Couldn't get ";d+=y&&a.businessId===y?"business":"shared",d+=" notebook: "+a.shareName+" at "+b+" because of ",extension.isThriftError(c)?(d+=c.__proto__.name,(c.errorCode||c.parameter)&&(d+="(",c.errorCode&&(d+=c.errorCode),c.parameter&&(d+=","+c.parameter),d+=")")):d+=JSON.stringify(c),log.error(d),y&&a.businessId===y?(A++,p()):(C++,q())}}function p(){if(D&&E&&A===z){var d=[];for(var e in F[x].linked){var f=F[x].linked[e],g=F[x].linkedGuidToGuid[f.guid],h=F[x].businessIndices.indexOf(g);if(h>-1){var i=F[x].business[h];i.restrictions.noCreateNotes||d.push({globalId:f.sharedNotebookGlobalId,guid:i.guid,name:f.shareName,noShareNotes:i.restrictions.noShareNotes,owner:i.contact.id!==x?i.contact.name||i.contact.username:null,shardId:f.shardId,stack:f.stack,type:a.NOTEBOOK_TYPE_BUSINESS,visibleToOthers:i.published})}}Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",alwaysStartInNotebookGuid:I,notebooks:d,recentNotebookGuid:H})}}function q(){if(D&&B===C){var d=[];for(var e in F[x].linked){var f=F[x].linked[e],g=F[x].linkedGuidToGuid[f.guid];if(g){var h=F[x].sharedIndices.indexOf(g);if(h>-1){var i=F[x].shared[h];if(!i.restrictions.noCreateNotes){var j=i.contact||F[x].sharedOwners[h];d.push({globalId:f.sharedNotebookGlobalId,guid:i.guid,name:f.shareName,noShareNotes:i.restrictions.noShareNotes,owner:j.name||j.username,shardId:f.shardId,stack:f.stack,type:a.NOTEBOOK_TYPE_LINKED,visibleToOthers:!0})}}}}Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveSharedNotebooks",alwaysStartInNotebookGuid:I,notebooks:d,recentNotebookGuid:H})}}function r(a,b,c,d,e){var f=b.indexOf(c.guid);f>-1?(a[f]=c,d&&e&&(d[f]=e)):(a.push(c),b.push(c.guid),d&&e&&d.push(e))}function s(a,b,c,d){var e=b.indexOf(c);e>-1&&(a.splice(e,1),b.splice(e,1),d&&d.splice(e,1))}function t(a){s(F[x].linked,F[x].linkedIndices,a);var b=F[x].linkedGuidToGuid[a];delete F[x].linkedGuidToGuid[a],b&&(s(F[x].shared,F[x].sharedIndices,b,F[x].sharedOwners),s(F[x].business,F[x].businessIndices,b))}var u=1,v=50,w=auth.getUserInfo(),x=parseInt(auth.getCurrentUser()),y=w.businessId,z=0,A=0,B=0,C=0,D=!1,E=!1,F=Persistent.get("notebooks");F||(F={}),(!F[x]||F[x].version<u)&&(F[x]={version:u}),F[x].personal||(F[x].personal=[],F[x].personalIndices=[]),F[x].linked||(F[x].linked=[],F[x].linkedIndices=[]),F[x].linkedGuidToGuid||(F[x].linkedGuidToGuid={}),F[x].shared||(F[x].shared=[],F[x].sharedIndices=[],F[x].sharedOwners=[]),w.bizAuthenticationToken&&(F[x].business||(F[x].business=[],F[x].businessIndices=[]));var G=Persistent.get("recentNotebooks");G||(G={});var H=G[x],I=null;"alwaysStartIn"===options.get("notebookSelection")&&(I=options.get("startNotebook"));var J=Persistent.get("updateCounts");J||(J={}),(!J[x]||J[x].version<u)&&(J[x]={version:u});var K=!0,L=!0,M=!0;J[x].personal||(J[x].personal=0,K=!1),J[x].linked||(J[x].linked=0,L=!1),w.bizAuthenticationToken&&(J[x].business||(J[x].business=0,M=!1));var N=extension.createNoteStoreClient(w.shardId),O={},P=null;w.bizAuthenticationToken&&(P=extension.createNoteStoreClient(w.bizShardId)),d()}function e(a,b){function c(){var a=auth.getUserInfo(),c=extension.createNoteStoreClient(a.shardId);if(c.listTags(a.authenticationToken,function(a){Browser.sendToTab(b.tab,{name:"receivePersonalTags",tags:a})},d),a.bizAuthenticationToken){var e=/^S=([^:]+)/.exec(a.bizAuthenticationToken)[1],f=extension.createNoteStoreClient(e);f.listTags(a.bizAuthenticationToken,function(a){Browser.sendToTab(b.tab,{name:"receiveBusinessTags",tags:a})},d)}}function d(a){console.log(a)}extension.getOption("alwaysTagWith")&&Browser.sendToTab(b.tab,{name:"receiveAlwaysTags",tags:extension.getOption("alwaysTags").split(/\s*,\s*/)}),c()}function f(){auth.isAuthenticated(function(a){if(a){var b=Persistent.get("notebooks");b&&(delete b[a.userId],Persistent.set("notebooks",b));var c=Persistent.get("updateCounts");c&&(delete c[a.userId],Persistent.set("updateCounts"))}else log.log("logged out while clearing cached filing info")})}var g={};return Browser.addMessageHandlers({getNotebooks:d,getSmartFilingInfo:c,getTags:e}),g.getSmartFilingInfo=c,g.clearCachedFilingInfo=f,b&&(g.getNotebooks=d),g});